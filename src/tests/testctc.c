/* Copyright (c) 2023-2024 Gilad Odinak */
#include <stdio.h>
#include "array.h"
#include "arrayio.h"
#include "ctc.h"
#define T 16 /* Number of time steps */
#define C 8  /* Number of classes    */
#define L 5  /* Target label length  */
const float blank = 0; /* Blank label index */

float yp[T][C] = { /* 1  3  4  1  2  3  2  6  5  1  5  1 */
    {0.1060,0.1887,0.1516,0.1327,0.0852,0.0852,0.0773,0.1734},
    {0.1356,0.1509,0.0759,0.1961,0.1709,0.0919,0.0892,0.0893},
    {0.1159,0.1445,0.1317,0.1144,0.1576,0.0983,0.1145,0.1233},
    {0.1258,0.1748,0.0974,0.1333,0.1442,0.0835,0.1464,0.0946},
    {0.0735,0.1779,0.1810,0.1546,0.0934,0.0760,0.1366,0.1070},
    {0.0899,0.1305,0.0823,0.1975,0.1030,0.1543,0.1086,0.1338},
    {0.1012,0.0705,0.1544,0.1271,0.1498,0.1433,0.1065,0.1472},
    {0.0972,0.1082,0.0930,0.1231,0.1312,0.1166,0.2037,0.1270},
    {0.0976,0.1268,0.0848,0.1643,0.0794,0.1977,0.1595,0.0899},
    {0.0764,0.1718,0.1541,0.1575,0.1643,0.0818,0.1088,0.0853},
    {0.1768,0.1391,0.1038,0.0795,0.1018,0.1032,0.1547,0.1411},
    {0.1631,0.1077,0.0757,0.1370,0.1437,0.1177,0.1452,0.1100},
    {0.1491,0.1355,0.0907,0.0985,0.0912,0.1670,0.1210,0.1470},
    {0.2024,0.1048,0.1231,0.1738,0.1027,0.0882,0.1091,0.0959},
    {0.1522,0.1348,0.1132,0.1436,0.1342,0.0724,0.1467,0.1030},
    {0.1535,0.1678,0.0941,0.0764,0.0860,0.1050,0.1552,0.1619}
};

float yt[T][C] = { /* 7 5 3 3 1 6 2 */
    {0.0,0.0,0.0,0.0,0.0,0.0,0.0,1.0}, /* 7 */
    {0.0,0.0,0.0,0.0,0.0,1.0,0.0,0.0}, /* 5 */
    {0.0,0.0,0.0,1.0,0.0,0.0,0.0,0.0}, /* 3 */
    {0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0},
    {0.0,0.0,0.0,1.0,0.0,0.0,0.0,0.0}, /* 3 */
    {0.0,1.0,0.0,0.0,0.0,0.0,0.0,0.0}, /* 1 */
    {0.0,0.0,0.0,0.0,0.0,0.0,1.0,0.0}, /* 6 */
    {0.0,0.0,1.0,0.0,0.0,0.0,0.0,0.0}, /* 2 */
    {0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0},
    {0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0},
    {0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0},
    {0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0},
    {0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0},
    {0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0},
    {0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0},
    {0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0}
};

float dy[T][C];

void print_labels(float (*a)[C], char* name)
{
     printf("%s: ",name);
     int pl = blank;
     for (int i = 0; i < T; i++) {
         int l = blank;
         for (int j = 0; j <  C; j++)
             if (a[i][j] > a[i][l])
                 l = j;
         if (l != blank && l != pl) {
             printf("%2d ",l);
         }
         if (l != pl) {
             pl = l;
         }
     }
     printf("\n");
}

int main()
{
    float lr = 0.01;
    float loss;
    CTC* ctc = ctc_create(T,C,blank);

    print_labels(yp,"predictions");
    print_labels(yt,"targets    ");
    print_array(yp,T,C,"yp:","%6.4f ",0);
    print_array(yt,T,C,"yt:","%2.0f ",0);

    loss = ctc_loss(ctc,yp,yt,T,C);
    printf("CTC loss: %7.4f\n",loss);
    fltclr(dy,T*C);
    dLdy_ctc_loss(ctc,yp,yt,dy,T,C);
    print_array(dy,T,C,"gradients:","%6.4f ",0);

    for (int k = 1; k < 28; k++) {
        for (int i = 0; i < T; i++)
            for (int j = 0; j < C; j++)
                yp[i][j] = yp[i][j] - lr * dy[i][j];
        for (int i = 0; i < T; i++) {
            float sum = 0.0;
            for (int j = 0; j < C; j++)
                sum += yp[i][j];
            for (int j = 0; j < C; j++)
                yp[i][j] /= sum;
        }
        loss = ctc_loss(ctc,yp,yt,T,C);
        printf("iter %3d, CTC loss: %7.4f\n",k,loss);
        fltclr(dy,T*C);
        dLdy_ctc_loss(ctc,yp,yt,dy,T,C);
        print_labels(yp,"predictions");
        print_labels(yt,"targets    ");
    }
    ctc_free(ctc);
}

